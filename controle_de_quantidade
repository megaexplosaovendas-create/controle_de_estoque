<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque V20 + Dashboard Di√°rio</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>

    <style>
        /* --- ESTILOS GERAIS (Fus√£o dos dois arquivos) --- */
        :root { 
            --primary: #0f766e; --bg: #f0fdfa; --text: #134e4a; 
            --success: #16a34a; --danger: #dc2626; 
            --card-bg: #ffffff; --border: #ccfbf1;
            --warning-bg: #fff1f2; --warning-border: #fecaca; --warning-text: #991b1b; 
        }
        
        /* Dark Mode (herdado do controle de etiquetas) */
        body.dark-mode { 
            --primary: #2dd4bf; --bg: #111827; --text: #f3f4f6; 
            --card-bg: #1f2937; --border: #374151;
            --success: #34d399; --danger: #f87171;
            --warning-bg: #450a0a; --warning-border: #7f1d1d; --warning-text: #fca5a5;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 15px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 10px; }
        .btn-toggle-dark { background: #374151; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        
        /* --- DASHBOARD / GR√ÅFICOS --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .chart-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .chart-container { position: relative; height: 250px; width: 100%; }
        
        .kpis { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .kpi-box { background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); flex: 1; min-width: 150px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-title { font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); }

        /* --- LAYOUT PRINCIPAL (Sidebar + Tabela) --- */
        .grid-main { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        
        .panel { background: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .panel-error { background: var(--warning-bg); border: 1px solid var(--warning-border); color: var(--warning-text); }
        
        /* Upload e Bot√µes */
        .btn-upload { background: var(--bg); border: 2px dashed var(--primary); padding: 20px; border-radius: 8px; cursor: pointer; text-align: center; width: 100%; display: block; font-weight: bold; color: var(--primary); transition: 0.2s; box-sizing: border-box; }
        .btn-upload:hover { background: var(--border); }
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box { flex-grow: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; }
        .btn-add { background: var(--success); color: white; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-reset { background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Tabela */
        .table-container { height: 500px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--card-bg); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #ccfbf1; color: #0f766e; padding: 12px; text-align: left; position: sticky; top: 0; z-index: 10; }
        body.dark-mode th { background: #111827; color: #2dd4bf; }
        td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: var(--bg); }
        
        .action-btn { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 1em; }
        .btn-edit { background: #fde047; color: #854d0e; }
        .btn-del { background: #fca5a5; color: #7f1d1d; }

        /* Tags e Listas */
        .tag-ok { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        .tag-low { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; }
        
        #errorList, #shortageList, #historyList { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; font-size: 0.9em; }
        #errorList li, #shortageList li, #historyList li { padding: 8px; border-bottom: 1px solid var(--border); }
        #historyList li { display: flex; justify-content: space-between; font-family: monospace; }

        /* Toasts */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--card-bg); border-left: 6px solid var(--danger); color: var(--text); padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); min-width: 250px; animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>üì¶ Estoque V20 + Dashboard</h1>
        <div class="header-actions">
            <button class="btn-toggle-dark" onclick="toggleDarkMode()">üåô Dark Mode</button>
            <button class="btn-reset" onclick="resetSystem()">‚ö†Ô∏è Resetar Tudo</button>
        </div>
    </header>

    <div class="kpis">
        <div class="kpi-box">
            <span class="kpi-title">Data Selecionada</span>
            <input type="date" id="dateFilter" style="border:none; font-weight:bold; color:var(--primary); background:transparent;" onchange="changeDate()">
        </div>
        <div class="kpi-box">
            <span class="kpi-title">Sa√≠das Hoje</span>
            <span class="kpi-value" id="kpiTotalToday">0</span>
        </div>
        <div class="kpi-box">
            <span class="kpi-title">Itens Negativos</span>
            <span class="kpi-value" id="kpiNegatives" style="color:var(--danger)">0</span>
        </div>
    </div>

    <div class="dashboard">
        <div class="chart-card">
            <h3>üìä Sa√≠das por Dia</h3>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>üìà Varia√ß√£o Di√°ria (%)</h3>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid-main">
        <div class="sidebar">
            <div class="panel">
                <h3>üìÑ Baixa Via PDF</h3>
                <p style="font-size:0.85em; opacity:0.7;">Ler arquivo de vendas e abater do estoque.</p>
                <label class="btn-upload">
                    Selecionar PDF
                    <input type="file" multiple accept=".pdf" style="display:none" onchange="processPDF(this)">
                </label>
            </div>

            <div class="panel">
                <h3>üïí Movimenta√ß√µes (<span id="historyDateLabel">Hoje</span>)</h3>
                <ul id="historyList">
                    <li style="font-style:italic; opacity:0.7;">Nenhuma movimenta√ß√£o.</li>
                </ul>
            </div>

            <div class="panel panel-error" id="panelNotFound" style="display:none;">
                <h3 style="margin-top:0;">‚ö†Ô∏è N√£o Encontrados</h3>
                <ul id="errorList"></ul>
            </div>

            <div class="panel panel-error" style="border-color: #ef4444; background: var(--warning-bg);">
                <h3 style="margin-top:0; color: #b91c1c;">üö® Estoque Negativo</h3>
                <ul id="shortageList"></ul>
            </div>
        </div>

        <div>
            <div class="toolbar">
                <input type="text" id="search" class="search-box" placeholder="üîç Buscar produto..." onkeyup="renderTable()">
                <button class="btn-add" onclick="openModal()">‚ûï Novo Produto</button>
            </div>

            <div class="table-container">
                <table id="table">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th style="width:80px;">Qtd</th>
                            <th style="width:80px;">Status</th>
                            <th style="width:100px; text-align:center;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            
            <div id="log" style="margin-top:20px; opacity:0.7; font-size:12px;"></div>
        </div>
    </div>
    
    <div id="toast-container" class="toast-container"></div>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <h2 id="modalTitle">Produto</h2>
        <input type="hidden" id="editIndex">
        <div class="form-group">
            <label>Nome do Produto</label>
            <input type="text" id="inpName">
        </div>
        <div class="form-group">
            <label>Aliases (Separe por v√≠rgula)</label>
            <input type="text" id="inpAliases">
        </div>
        <div class="form-group">
            <label>Quantidade</label>
            <input type="number" id="inpQty">
        </div>
        <div class="modal-actions">
            <button onclick="closeModal()" style="padding:8px 15px; border:none; cursor:pointer;">Cancelar</button>
            <button onclick="saveProduct()" style="padding:8px 15px; background:var(--success); color:white; border:none; font-weight:bold; cursor:pointer;">Salvar</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. CONFIGURA√á√ÉO E DADOS INICIAIS
    // ==========================================
    const initialDatabaseRaw = [
        { id: "KP397", display: "KP-397", qty: 300, aliases: ["KP397"] },
        { id: "ONM0001", display: "ON-M0001", qty: 300, aliases: ["ONM0001", "KPM0001"] },
        { id: "KPRO826", display: "KP-RO826", qty: 300, aliases: ["KPRO826"] },
        { id: "KPRO852", display: "kp-ro852", qty: 300, aliases: ["KPRO852"] },
        { id: "LB521", display: "LB-521", qty: 300, aliases: ["LB521"] },
        { id: "ONFN632PRETO", display: "ON-FN632PRETO", qty: 300, aliases: ["ONFN632PRETO"] },
        { id: "ONFN632AZUL", display: "ON-FN632AZUL", qty: 300, aliases: ["ONFN632AZUL"] },
        { id: "ONFN632BRANCO", display: "ON-FN632BRANCO", qty: 300, aliases: ["ONFN632BRANCO"] },
        { id: "ONFN632LILAS", display: "ON-FN632LILAS", qty: 300, aliases: ["ONFN632LILAS"] },
        { id: "ONFN632VERDE", display: "ON-FN632VERDE", qty: 300, aliases: ["ONFN632VERDE"] },
        { id: "ONFN632ROSA", display: "ON-FN632ROSA", qty: 300, aliases: ["ONFN632ROSA"] },
        { id: "KPTE112VERDE", display: "KP-TE112VERDE", qty: 300, aliases: ["KPTE112VERDE", "KPTE112VERDE"] },
        { id: "KPTE112PRETO", display: "KP-TE112PRETO", qty: 300, aliases: ["KPTE112PRETO", "KPTE112PRETO"] },
        { id: "KPTE112ROSA", display: "KP-TE112ROSA", qty: 300, aliases: ["KPTE112ROSA", "KPTE112ROSA"] },
        { id: "PG90232S", display: "PG-90232S", qty: 300, aliases: ["PG90232S", "PG9023S"] },
        { id: "KP7023ALEATORIO", display: "KP-7023ALEATORIO", qty: 300, aliases: ["KP7023ALEATORIO"] },
        { id: "KP7023AZUL", display: "KP-7023AZUL", qty: 300, aliases: ["KP7023AZUL"] },
        { id: "KP7023BRANCO", display: "KP-7023BRANCO", qty: 300, aliases: ["KP7023BRANCO"] },
        { id: "KP7023PRETO", display: "KP-7023PRETO", qty: 300, aliases: ["KP7023PRETO"] },
        { id: "KPRO833", display: "KP-RO833", qty: 300, aliases: ["KPRO833"] },
        { id: "KPIM600", display: "KP-IM600", qty: 300, aliases: ["KPIM600", "IM600"] },
        { id: "DLY04", display: "D-LY04", qty: 300, aliases: ["DLY04"] },
        { id: "KPTE149", display: "KP-TE149", qty: 300, aliases: ["KPTE149"] },
        { id: "KPTE129", display: "KP-TE129", qty: 300, aliases: ["KPTE129"] },
        { id: "KP2064", display: "KP-2064", qty: 300, aliases: ["KP2064"] },
        { id: "KPTC19", display: "KP-TC19", qty: 300, aliases: ["KPTC19", "ACIONADORKPTC19"] },
        { id: "ORCO024", display: "OR-CO024", qty: 300, aliases: ["ORCO024"] },
        { id: "ORCO025", display: "OR-CO025", qty: 300, aliases: ["ORCO025"] },
        { id: "ORCO026", display: "OR-CO026", qty: 300, aliases: ["ORCO026"] },
        { id: "ORCO027", display: "OR-CO027", qty: 300, aliases: ["ORCO027"] },
        { id: "ORCO028", display: "OR-CO028", qty: 300, aliases: ["ORCO028"] },
        { id: "ORCO029", display: "OR-CO029", qty: 300, aliases: ["ORCO029"] },
        { id: "KPTE115", display: "KP-TE115", qty: 300, aliases: ["KPTE115", "TE115FONELEBOSS", "TE115"] },
        { id: "KPTE119", display: "KP-TE119", qty: 300, aliases: ["KPTE119", "TE119"] },
        { id: "KP6040", display: "KP-6040", qty: 300, aliases: ["KP6040"] },
        { id: "ORCO18M", display: "OR-CO18/M", qty: 300, aliases: ["ORCO18M"] },
        { id: "PN898", display: "PN-898", qty: 300, aliases: ["PN898", "PN899PDBRANCO", "PN899PDBRANCO", "PN899PDBRANCO"] },
        { id: "PN899", display: "PN-899", qty: 300, aliases: ["PN899", "PN899PDPRETO", "PN899PDPRETO", "PN899PDPRETO"] },
        { id: "DY03PRETO", display: "D-Y03PRETO", qty: 300, aliases: ["DY03PRETO"] },
        { id: "DY03VERMELHO", display: "D-Y03VERMELHO", qty: 300, aliases: ["DY03VERMELHO"] },
        { id: "DY03AZUL", display: "D-Y03AZUL", qty: 300, aliases: ["DY03AZUL"] },
        { id: "DY03LARANJA", display: "D-Y03LARANJA", qty: 300, aliases: ["DY03LARANJA"] },
        { id: "DY03CINZA", display: "D-Y03CINZA", qty: 300, aliases: ["DY03CINZA"] },
        { id: "DY03ALEATORIO", display: "D-Y03ALEATORIO", qty: 300, aliases: ["DY03ALEATORIO"] },
        { id: "DP13UK", display: "D-P13UK", qty: 300, aliases: ["DP13UK"] },
        { id: "D-P13AFRICA", display: "D-P13AFRICA", qty: 300, aliases: ["D-P13AFRICA"] },
        { id: "D-P13INGLATERRA", display: "D-P13INGLATERRA", qty: 300, aliases: ["D-P13INGLATERRA"] },
        { id: "D-P13AZUL", display: "D-P13AZUL", qty: 300, aliases: ["D-P13AZUL"] },
        { id: "D-P13CAMUFLADO VERDE", display: "D-P13CAMUFLADO VERDE", qty: 300, aliases: ["D-P13CAMUFLADO VERDE", "D-P13CAMUFLADA VERDE"] },
        { id: "D-P13CAMUFLADO AZUL", display: "D-P13CAMUFLADO AZUL", qty: 300, aliases: ["D-P13CAMUFLADO AZUL", "D-P13CAMUFLADA AZUL"] },
        { id: "D-P13PRETO", display: "D-P13PRETO", qty: 300, aliases: ["D-P13PRETO"] },
        { id: "D-P13MONUMENTOS", display: "D-P13MONUMENTOS", qty: 300, aliases: ["D-P13MONUMENTOS"] },
        { id: "D3208", display: "D-3208", qty: 300, aliases: ["D3208", "D3204"] },
        { id: "D4232", display: "D-4232", qty: 300, aliases: ["D-4232"] },
        { id: "DF12CLARO", display: "D-F12 Claro", qty: 300, aliases: ["DF12CLARO", "DF11BTMARROMCLARO"] },
        { id: "DF12ESCURO", display: "D-F12 Escuro", qty: 300, aliases: ["DF12ESCURO", "DF11BTMARROMCLARO"] },
        { id: "D3142", display: "D-3142", qty: 300, aliases: ["D3142", "D3142MIC", "D3142"] },
        { id: "DF8ESCURO", display: "D-F8 Escuro", qty: 300, aliases: ["DF8ESCURO", "DF8MARROMESCURO", "DF8ESCURA"] },
        { id: "DF8CLARO", display: "D-F8 Claro", qty: 300, aliases: ["DF8CLARO", "DF8MARROMCLARO", "DF8CLARO"] },
        { id: "DG105", display: "D-G105", qty: 300, aliases: ["DG105"] },
        { id: "DEM07", display: "D-EM07", qty: 300, aliases: ["DEM07"] },
        { id: "DS4145", display: "D-S4145", qty: 300, aliases: ["DS4145", "DS4150"] },
        { id: "D3205", display: "D-3205", qty: 300, aliases: ["D3205"] },
        { id: "D1601VERMELHO", display: "D-1601VERMELHO", qty: 300, aliases: ["D1601VERMELHO"] },
        { id: "D1601MARROM", display: "D-1601MARROM", qty: 300, aliases: ["D1601MARROM"] },
        { id: "D1601AZUL", display: "D-1601AZUL", qty: 300, aliases: ["D1601AZUL"] },
        { id: "DBH1019ROSA", display: "D-BH1019ROSA", qty: 300, aliases: ["DBH1019ROSA"] },
        { id: "DBH1019ROSE", display: "D-BH1019ROSE", qty: 300, aliases: ["DBH1019ROSE"] },
        { id: "DBH1019VERMELHO", display: "D-BH1019VERMELHO", qty: 300, aliases: ["DBH1019VERMELHO"] },
        { id: "DBH1019CINZA", display: "D-BH1019CINZA", qty: 300, aliases: ["DBH1019CINZA", "DBH1019PRATA"] },
        { id: "DBH1019AZUL", display: "D-BH1019AZUL", qty: 300, aliases: ["DBH1019AZUL"] },
        { id: "DBH1019PRETO", display: "D-BH1019PRETO", qty: 300, aliases: ["DBH1019PRETO"] },
        { id: "DXK101", display: "D-XK101", qty: 300, aliases: ["DXK101"] },
        { id: "DY07", display: "D-Y07", qty: 300, aliases: ["DY07"] },
        { id: "DBH1051VERMELHO", display: "D-BH1051VERMELHO", qty: 300, aliases: ["DBH1051VERMELHO", "DBH1051VERMELHO"] },
        { id: "DBH1051PRETO", display: "D-BH1051PRETO", qty: 300, aliases: ["DBH1051PRETO"] },
        { id: "DBH1051ROSE", display: "D-BH1051ROSE", qty: 300, aliases: ["DBH1051ROSE"] },
        { id: "DBH1051CINZA", display: "D-BH1051CINZA", qty: 300, aliases: ["DBH1051CINZA", "DBH1051PRATA"] },
        { id: "DBH1051AZUL", display: "D-BH1051AZUL", qty: 300, aliases: ["DBH1051AZUL"] },
        { id: "DS3151", display: "D-S3151", qty: 300, aliases: ["DS3151", "DS3151"] },
        { id: "DBH1065ROSA", display: "D-BH1065ROSA", qty: 300, aliases: ["DBH1065ROSA"] },
        { id: "DBH1065AZUL", display: "D-BH1065AZUL", qty: 300, aliases: ["DBH1065AZUL"] },
        { id: "DBH1065PRATA", display: "D-BH1065PRATA", qty: 300, aliases: ["DBH1065PRATA"] },
        { id: "DBH1065PRETO", display: "D-BH1065PRETO", qty: 300, aliases: ["DBH1065PRETO"] },
        { id: "DBH1065VERMELHO", display: "D-BH1065VERMELHO", qty: 300, aliases: ["DBH1065VERMELHO"] },
        { id: "DBH1065ROSE", display: "D-BH1065ROSE", qty: 300, aliases: ["DBH1065ROSE"] },
        { id: "DBH1050PRETO", display: "D-BH1050PRETO", qty: 300, aliases: ["DBH1050PRETO"] },
        { id: "DG123CINZALISTRADO", display: "D-G123CINZA LISTRADO", qty: 300, aliases: ["D-G123CINZA LISTRADO"] },
        { id: "DBH1050AZUL", display: "D-BH1050AZUL", qty: 300, aliases: ["DBH1050AZUL"] },
        { id: "DBH1050PRATA", display: "D-BH1050PRATA", qty: 300, aliases: ["DBH1050PRATA"] },
        { id: "DBH1050VERMELHO", display: "D-BH1050VERMELHO", qty: 300, aliases: ["DBH1050VERMELHO"] },
        { id: "DBH1050ROSA", display: "D-BH1050ROSA", qty: 300, aliases: ["DBH1050ROSA"] },
        { id: "DBH1050ROSE", display: "D-BH1050ROSE", qty: 300, aliases: ["DBH1050ROSE"] },
        { id: "DBH1018PRETO", display: "D-BH1018PRETO", qty: 300, aliases: ["DBH1018PRETO"] },
        { id: "DBH1018PRATA", display: "D-BH1018PRATA", qty: 300, aliases: ["DBH1018PRATA"] },
        { id: "DBH1018VERMELHO", display: "D-BH1018VERMELHO", qty: 300, aliases: ["DBH1018VERMELHO"] },
        { id: "DBH1018ROSA", display: "D-BH1018ROSA", qty: 300, aliases: ["DBH1018ROSA"] },
        { id: "DBH1018ROSE", display: "D-BH1018ROSE", qty: 300, aliases: ["DBH1018ROSE"] },
        { id: "DBH1066PRETO", display: "D-BH1066PRETO", qty: 300, aliases: ["DBH1066PRETO"] },
        { id: "DBH1066AZUL", display: "D-BH1066AZUL", qty: 300, aliases: ["DBH1066AZUL"] },
        { id: "DBH1066PRATA", display: "D-BH1066PRATA", qty: 300, aliases: ["DBH1066PRATA"] },
        { id: "DBH1066VERMELHO", display: "D-BH1066VERMELHO", qty: 300, aliases: ["DBH1066VERMELHO"] },
        { id: "DBH1066ROSA", display: "D-BH1066ROSA", qty: 300, aliases: ["DBH1066ROSA"] },
        { id: "DBH1066ROSE", display: "D-BH1066ROSE", qty: 300, aliases: ["DBH1066ROSE"] },
        { id: "DBH1064VERMELHO", display: "D-BH1064VERMELHO", qty: 300, aliases: ["DBH1064VERMELHO"] },
        { id: "DBH1064ROSE", display: "D-BH1064ROSE", qty: 300, aliases: ["DBH1064ROSE"] },
        { id: "DBH1064AZUL", display: "D-BH1064AZUL", qty: 300, aliases: ["DBH1064AZUL"] },
        { id: "DBH1064ROSA", display: "D-BH1064ROSA", qty: 300, aliases: ["DBH1064ROSA"] },
        { id: "DBH1064PRETO", display: "D-BH1064PRETO", qty: 300, aliases: ["DBH1064PRETO"] },
        { id: "DBH1064CINZA", display: "D-BH1064CINZA", qty: 300, aliases: ["DBH1064CINZA"] },
        { id: "DS3158PRETO", display: "D-S3158PRETO", qty: 300, aliases: ["D-S3158PRETO"] },
        { id: "DS3158VERDE", display: "D-S3158VERDE", qty: 300, aliases: ["D-S3158VERDE"] },
        { id: "DS3158AZUL", display: "D-S3158AMARELO", qty: 300, aliases: ["D-S3158AMARELO"] },
        { id: "DS3158AMARELO", display: "D-S3158AZUL", qty: 300, aliases: ["D-S3158AZUL"] },
        { id: "R35SLARANJA", display: "R35SLARANJA", qty: 300, aliases: ["R35SLARANJA"] },
        { id: "KPRO802", display: "KP-RO802", qty: 300, aliases: ["KP-RO802"] },
        { id: "DBAG1", display: "D-BAG1", qty: 300, aliases: ["D-BAG1"] },
        { id: "DG123VERMELHO", display: "D-G123VERMELHO", qty: 300, aliases: ["D-G123VERMELHO"] },
        { id: "DG123COLORIDO", display: "D-G123COLORIDO", qty: 300, aliases: ["D-G123COLORIDO"] },
        { id: "DG123VERDECAMUFLADO", display: "D-G123VERDE CAMUFLADO", qty: 300, aliases: ["D-G123VERDE CAMUFLADO"] },
        { id: "D-G123CINZALISTRADO", display: "D-G123CINZA LISTRADO", qty: 300, aliases: ["D-G123VERMELHO"] },
        { id: "DG123PRETO", display: "D-G123PRETO", qty: 300, aliases: ["D-G123PRETO"] },
        { id: "DG123CINZA", display: "D-G123CINZA", qty: 300, aliases: ["D-G123CINZA"] },
        { id: "DG123ALEATORIO", display: "D-G123ALEATORIO", qty: 300, aliases: ["D-G123ALEATORIO"] },
        { id: "KPMU003", display: "KP-MU003", qty: 300, aliases: ["KP-MU003"] },
        { id: "KPRO832", display: "KP-RO832", qty: 300, aliases: ["KP-RO832"] },
        { id: "DBH1064CINZA", display: "D-BH1064CINZA", qty: 300, aliases: ["DBH1064CINZA"] },
        { id: "DS4151", display: "D-S4151", qty: 300, aliases: ["D-S4151"] },
        { id: "BOM3108", display: "BOM-3108", qty: 300, aliases: ["BOM-3108"] },
        { id: "D3210", display: "D-3210", qty: 300, aliases: ["D-3210"] },
        { id: "GL8800", display: "GL-8800", qty: 300, aliases: ["GL8800", "DWKMG305MARROM", "DWKMG305MARROM", "DWKMG305LARANJA", "DWKMG305MARROM"] },
        { id: "DWKMG305", display: "DWKM-G305", qty: 300, aliases: ["DWKMG305", "DWKMG305VERDE", "DWKMG305VERDE"] },
        { id: "PROTETORAURICULAR", display: "PROTETOR AURICULAR", qty: 300, aliases: ["PROTETORAURICULAR"] },
        { id: "DL2007A", display: "DL-2007A", qty: 300, aliases: ["DL2007A", "DL2007A"] },
        { id: "CS30", display: "CS-30", qty: 300, aliases: ["CS30"] },
        { id: "LC877", display: "LC-877", qty: 300, aliases: ["LC877", "LC877ROSA", "LC877AZUL", "LC877PRETO", "LC877VERMELHO"] },
        { id: "BOM6401", display: "BOM-6401", qty: 300, aliases: ["BOM6401"] },
        { id: "DL758", display: "DL-758", qty: 300, aliases: ["DL758"] },
        { id: "KP-RO834", display: "KP-RO834", qty: 300, aliases: ["KP-RO834"] },
        { id: "KP-TC07", display: "KP-TC07", qty: 300, aliases: ["KP-TC07"] },
        { id: "R43BRANCO", display: "R43BRANCO", qty: 300, aliases: ["R43BRANCO"] },
        { id: "R43PRETO", display: "R43PRETO", qty: 300, aliases: ["R43PRETO"] },
        { id: "CRV", display: "CRV(KIT FERRAMENTA)", qty: 300, aliases: ["CRVKITFERRAMENTA", "CRV"] },
        { id: "DS8202", display: "D-S8202", qty: 300, aliases: ["DS8202", "D-8202", "CAIXAGRANDEDS8202", "DS8202"] },
        { id: "DY05PRO", display: "D-Y05PRO", qty: 300, aliases: ["DY05PRO", "DY05PRO"] },
        { id: "DY05", display: "D-Y05", qty: 300, aliases: ["DY05"] },
        { id: "DY04", display: "D-Y04", qty: 300, aliases: ["DY04"] },
        { id: "DX608VERDE", display: "D-X608VERDE", qty: 300, aliases: ["DX608VERDE", "DX608VERDE"] },
        { id: "DX608VERMELHO", display: "D-X608VERMELHO", qty: 300, aliases: ["DX608VERMELHO", "DX608VERMELHO"] },
        { id: "DX608PRETO", display: "D-X608PRETO", qty: 300, aliases: ["DX608PRETO", "DX608PRETO"] },
        { id: "DX608ALEATORIO", display: "D-X608-Aleat√≥rio", qty: 300, aliases: ["DX608ALEATORIO", "DX608ALEATORIO", "DX608ALEATORIO"] },
        { id: "DX612CINZA", display: "D-X612CINZA", qty: 300, aliases: ["DX612CINZA"] },
        { id: "DX612VERDE", display: "D-X612VERDE", qty: 300, aliases: ["DX612VERDE"] },
        { id: "DX612", display: "D-X612", qty: 300, aliases: ["DX612"] },
        { id: "DBAR02", display: "D-BAR02", qty: 300, aliases: ["DBAR02"] },
        { id: "MILO7AZUL", display: "MILO7AZUL", qty: 300, aliases: ["MILO7AZUL"] },
        { id: "MILO7ROSA", display: "MILO7ROSA", qty: 300, aliases: ["MILO7ROSA"] },
        { id: "MILO7ALEATORIO", display: "MILO7ALEATORIO", qty: 300, aliases: ["MILO7ALEATORIO"] },
        { id: "MIL10CINZA", display: "MIL10CINZA", qty: 300, aliases: ["MIL10CINZA"] },
        { id: "MIL10DOURADO", display: "MIL10 DOURADO", qty: 300, aliases: ["MIL10DOURADO"] },
        { id: "MIL10AZUL", display: "MIL10 AZUL", qty: 300, aliases: ["MIL10AZUL"] },
        { id: "MIL10ROXO", display: "MIL10 ROXO", qty: 300, aliases: ["MIL10ROXO"] },
        { id: "MIL10ALEATORIO", display: "MIL10 ALEAT√ìRIO", qty: 300, aliases: ["MIL10ALEATORIO"] },
        { id: "DAI06", display: "D-AI06", qty: 300, aliases: ["DAI06"] },
        { id: "DX338VERMELHO", display: "D-X338VERMELHO", qty: 300, aliases: ["DX338VERMELHO", "DAI06"] },
        { id: "DX338PRETO", display: "D-X338PRETO", qty: 300, aliases: ["DX338PRETO"] },
        { id: "DX338AZUL", display: "D-X338AZUL", qty: 300, aliases: ["DX338AZUL"] },
        { id: "DLED04", display: "D-LED04", qty: 300, aliases: ["DLED04"] },
        { id: "DGP201", display: "D-GP201", qty: 300, aliases: ["DGP201"] },
        { id: "A24E9905", display: "A-24E99-05", qty: 300, aliases: ["A24E9905"] },
        { id: "DAI05", display: "D-AI05", qty: 300, aliases: ["DAI05"] },
        { id: "DTELA04", display: "D-TELA04", qty: 300, aliases: ["DTELA04"] },
        { id: "DTELA03", display: "D-TELA03", qty: 300, aliases: ["DTELA03"] },
        { id: "DAI08", display: "D-AI08", qty: 300, aliases: ["DAI08"] },
        { id: "DTELA02", display: "D-TELA02", qty: 300, aliases: ["DTELA02"] },
        { id: "DMN001", display: "D-MN001", qty: 300, aliases: ["DMN001", "MONITORDMN001"] },
        { id: "DAI13", display: "D-AI13", qty: 300, aliases: ["DAI13"] },
        { id: "DBAR01", display: "D-BAR01", qty: 300, aliases: ["DBAR01"] },
        { id: "AS08", display: "AS-08", qty: 300, aliases: ["AS08"] },
        { id: "DFT710", display: "D-FT710", qty: 300, aliases: ["DFT710"] },
        { id: "DFT101", display: "D-FT101", qty: 300, aliases: ["DFT101"] },
        { id: "DNK1201", display: "D-NK1201", qty: 300, aliases: ["DNK1201"] },
        { id: "DS8122", display: "D-S8122", qty: 300, aliases: ["DS8122"] },
        { id: "KP5816", display: "KP-5816", qty: 300, aliases: ["KP5816"] },
        { id: "DXK803", display: "D-XK803", qty: 300, aliases: ["DXK803"] },
        { id: "DX011", display: "D-X011", qty: 300, aliases: ["DX011"] },
        { id: "DXK103", display: "D-XK103", qty: 300, aliases: ["DXK103"] },
        { id: "DM01", display: "D-M01", qty: 300, aliases: ["DM01"] },
        { id: "DM02", display: "D-M02", qty: 300, aliases: ["DM02"] },
        { id: "DM03", display: "D-M03", qty: 300, aliases: ["DM03"] },
        { id: "FONE-LEBOSS", display: "FONE-LEBOSS", qty: 300, aliases: ["FONE-LEBOSS"] },
        { id: "D-GP203", display: "D-GP203", qty: 300, aliases: ["D-GP203"] },
        { id: "TE-118", display: "TE-118", qty: 300, aliases: ["TE-118"] },
        { id: "ONFT105110V", display: "ON-FT105-110V", qty: 300, aliases: ["ONFT105110V"] },
        { id: "ONFT105220V", display: "ON-FT105-220V", qty: 300, aliases: ["ONFT105220V"] },
        { id: "R43", display: "R43", qty: 300, aliases: ["R43", "r43", "R-43", "R 43"] },
        { id: "DX00", display: "D-X00", qty: 300, aliases: ["DX00", "D-X00", "dx00", "D X00", "d-x00"] },
        { id: "DM473", display: "D-M473", qty: 300, aliases: ["DM473", "D-M473", "dm473", "D M473"] },
        { id: "KP7023", display: "KP-7023", qty: 300, aliases: ["KP7023", "KP-7023", "kp7023", "KP 7023"] },
        { id: "ONFN632", display: "ON-FN632", qty: 300, aliases: ["ONFN632", "ON-FN632", "onfn632", "ON FN632"] },
        { id: "DBH1064", display: "D-BH1064", qty: 300, aliases: ["DBH1064", "D-BH1064", "dbh1064", "D BH1064"] },
        { id: "DG860AZUL", display: "D-G860AZUL", qty: 300, aliases: ["DG860AZUL", "D-G860AZUL", "dg860azul", "D G860 AZUL"] },
        { id: "DBH1050", display: "D-BH1050", qty: 300, aliases: ["DBH1050", "D-BH1050", "dbh1050", "D BH1050"] },
        { id: "ONTWS16", display: "ON-TWS16", qty: 300, aliases: ["ONTWS16", "ON-TWS16", "ontws16", "ON TWS16"] },
        { id: "DF11BT", display: "D-F11BT", qty: 300, aliases: ["DF11BT", "D-F11BT", "df11bt", "D F11BT"] },
        { id: "MILO07", display: "MILO07", qty: 300, aliases: ["MILO07", "milo07", "MILO 07"] }
    ];

    const STORAGE_KEY = 'estoque_v20';
    const HISTORY_KEY = 'historico_v20';
    
    // Auto corre√ß√£o na inicializa√ß√£o
    let inventory = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initialDatabaseRaw.map(item => ({
        ...item,
        id: generateID(item.id),
        aliases: item.aliases.map(a => generateID(a))
    }));
    
    // Hist√≥rico de sa√≠das: { 'YYYY-MM-DD': { total: 0, items: [{name, qty, time}] } }
    let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || {};

    // ==========================================
    // 2. FUN√á√ïES DE UTILIDADE E L√ìGICA
    // ==========================================
    function cleanName(str) {
        if (!str) return "";
        let s = str.toUpperCase().trim();
        s = s.replace(/(?:\s+COM|\s+MAIS|\s+C\/|\s+E|\s*\+)\s*MIC(?:ROFONE|RO)?/g, "");
        s = s.replace(/\s+MIC(?:ROFONE|RO)?$/g, "");
        s = s.replace(/\bBCO\b/g, "BRANCO").replace(/\bROS√ä\b/g, "ROSE");
        s = s.replace(/[√á]/g, "C").replace(/[√É√Å]/g, "A").replace(/[√ï√ì]/g, "O").replace(/[√â]/g, "E").replace(/[√ç]/g, "I").replace(/[√ö]/g, "U");
        return s.trim();
    }
    
    function generateID(rawName) { return cleanName(rawName).replace(/[^A-Z0-9]/g, ""); }
    function getToday() { return new Date().toISOString().split('T')[0]; }
    function formatTime() { return new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}); }

    function showToast(titulo, mensagem) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<strong>‚ö†Ô∏è ${titulo}</strong><span>${mensagem}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = "fadeOut 0.5s ease-out forwards";
            setTimeout(() => toast.remove(), 500);
        }, 5000);
    }

    // ==========================================
    // 3. PROCESSAMENTO DE ESTOQUE E PDF
    // ==========================================
    function findProdObject(searchId) {
        return inventory.find(p => p.id === searchId || (p.aliases && p.aliases.includes(searchId)));
    }

    function applySale(product, qty) {
        if(product) {
            // 1. Abate do estoque
            product.qty -= qty;
            
            // 2. Registra no hist√≥rico (Dashboard)
            const today = getToday();
            if(!history[today]) history[today] = { total: 0, items: [] };
            
            history[today].total += qty;
            history[today].items.push({
                name: product.display,
                qty: qty,
                time: formatTime()
            });

            save();
            log(`[BAIXA] ${product.display}: -${qty}`);
        }
    }

    async function processPDF(input) {
        if(!input.files.length) return;
        log(`‚è≥ Lendo ${input.files.length} arquivo(s)...`);
        
        let notFoundItems = [];
        let totalAbatido = 0;

        for(let file of input.files) {
            try {
                let typed = await readPDFBytes(file);
                let pdf = await pdfjsLib.getDocument(typed).promise;

                for(let i=1; i<=pdf.numPages; i++) {
                    let page = await pdf.getPage(i);
                    let content = await page.getTextContent();
                    
                    let rows = {}, rowKeys = [];
                    content.items.forEach(item => {
                        let y = item.transform[5]; 
                        let foundKey = rowKeys.find(key => Math.abs(key - y) < 5);
                        if(foundKey) rows[foundKey].push(item.str);
                        else { rows[y] = [item.str]; rowKeys.push(y); }
                    });
                    rowKeys.sort((a,b) => b - a);
                    
                    for(let y of rowKeys) {
                        let lineText = rows[y].join(' ');
                        let match = lineText.match(/(.*?)\s+(?:x|X|√ó|‚òë|v)\s*(\d+)\s*$/);
                        
                        if(match) {
                            let extractedName = match[1].trim().replace(/^["\s]+|["\s]+$/g, "");
                            let qty = parseInt(match[2]);
                            let foundItem = identifyProductSingleLine(extractedName);

                            if(foundItem) {
                                applySale(foundItem, qty);
                                totalAbatido += qty;
                            } else if(extractedName.length > 1) {
                                notFoundItems.push({ name: extractedName, qty: qty });
                                showToast("Produto N√£o Encontrado", `O item "${extractedName}" n√£o est√° no sistema.`);
                            }
                        }
                    }
                }
            } catch(e) { log(`Erro: ${e.message}`); }
        }
        
        save();
        renderAll();
        renderErrors(notFoundItems);
        alert(`Conclu√≠do! ${totalAbatido} itens abatidos.`);
        input.value = "";
    }

    function identifyProductSingleLine(rawString) {
        if(!rawString) return null;
        let idSearch = generateID(rawString);
        let found = findProdObject(idSearch);
        if(found) return found;
        return inventory.find(p => idSearch.includes(p.id) || (p.aliases && p.aliases.some(a => idSearch.includes(a))));
    }

    function readPDFBytes(file) {
        return new Promise(r => { let fr=new FileReader(); fr.onload=()=>r(new Uint8Array(fr.result)); fr.readAsArrayBuffer(file); });
    }

    // ==========================================
    // 4. CRUD MANUAL
    // ==========================================
    function saveProduct() {
        let index = parseInt(document.getElementById('editIndex').value);
        let rawName = document.getElementById('inpName').value.trim();
        let qty = parseInt(document.getElementById('inpQty').value);
        let rawAliases = document.getElementById('inpAliases').value;

        if (!rawName) return alert("Digite o nome!");
        let name = cleanName(rawName); 
        let id = generateID(name);
        let aliasesArr = rawAliases.split(',').map(a => generateID(a)).filter(a => a.length > 0);
        if (!aliasesArr.includes(id)) aliasesArr.push(id); 

        if (index >= 0) {
            inventory[index].display = name;
            inventory[index].qty = qty;
            inventory[index].id = id;
            inventory[index].aliases = aliasesArr;
        } else {
            if (findProdObject(id)) return alert("Produto j√° existe!");
            inventory.push({ id, display: name, qty, aliases: aliasesArr });
        }
        closeModal();
        save();
        renderAll();
    }

    function deleteProduct(index) {
        if(confirm(`Excluir ${inventory[index].display}?`)) {
            inventory.splice(index, 1);
            save();
            renderAll();
        }
    }

    function openModal(index = -1) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('editIndex').value = index;
        if (index >= 0) {
            let item = inventory[index];
            document.getElementById('modalTitle').innerText = "Editar Produto";
            document.getElementById('inpName').value = item.display;
            document.getElementById('inpQty').value = item.qty;
            document.getElementById('inpAliases').value = item.aliases.join(', ');
        } else {
            document.getElementById('modalTitle').innerText = "Novo Produto";
            document.getElementById('inpName').value = "";
            document.getElementById('inpQty').value = 300;
            document.getElementById('inpAliases').value = "";
        }
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    // ==========================================
    // 5. RENDERIZA√á√ÉO E DASHBOARD
    // ==========================================
    let barChart, lineChart;

    function renderAll() {
        renderTable();
        renderShortages();
        renderHistory();
        updateCharts();
        updateKPIs();
    }

    function renderTable() {
        const tbody = document.getElementById('tbody');
        const searchRaw = document.getElementById('search').value;
        const search = generateID(searchRaw);
        const searchDisplay = searchRaw.toUpperCase();

        tbody.innerHTML = "";
        inventory.filter(i => 
            i.id.includes(search) || i.display.toUpperCase().includes(searchDisplay) || (i.aliases && i.aliases.some(a => a.includes(search)))
        ).slice(0, 100).forEach((item) => {
            let realIndex = inventory.indexOf(item);
            let cls = item.qty > 50 ? 'tag-ok' : 'tag-low';
            tbody.innerHTML += `<tr>
                <td><strong>${item.display}</strong><br><span style="font-size:0.75em; color:#888;">IDs: ${item.aliases.slice(0,3).join(', ')}...</span></td>
                <td style="font-weight:bold; font-size:1.1em;">${item.qty}</td>
                <td><span class="${cls}">${item.qty > 0 ? 'OK' : 'BAIXO'}</span></td>
                <td style="text-align:center;">
                    <button class="action-btn btn-edit" onclick="openModal(${realIndex})">‚úèÔ∏è</button>
                    <button class="action-btn btn-del" onclick="deleteProduct(${realIndex})">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
    }

    function renderShortages() {
        const list = document.getElementById('shortageList');
        const negatives = inventory.filter(i => i.qty < 0);
        list.innerHTML = negatives.length ? "" : "<li style='color:var(--success);'>‚úÖ Nenhum item em falta</li>";
        negatives.forEach(item => {
            list.innerHTML += `<li>
                <strong style="color:var(--danger); font-size: 1.1em;">FALTA ${Math.abs(item.qty)}</strong>
                <span style="display:block; font-weight:500;">${item.display}</span>
            </li>`;
        });
    }

    function renderErrors(items) {
        const list = document.getElementById('errorList');
        const panel = document.getElementById('panelNotFound');
        if(items.length > 0) {
            panel.style.display = 'block';
            list.innerHTML = "";
            items.forEach(err => list.innerHTML += `<li><strong style="color:var(--danger);">${err.qty}x UNK</strong><span>"${err.name}"</span></li>`);
        } else {
            panel.style.display = 'none';
        }
    }

    // --- L√ìGICA DE HIST√ìRICO E GR√ÅFICOS ---
    function getSelectedDate() {
        return document.getElementById('dateFilter').value || getToday();
    }
    
    function changeDate() {
        renderHistory();
        updateKPIs();
    }

    function renderHistory() {
        const date = getSelectedDate();
        document.getElementById('historyDateLabel').innerText = date === getToday() ? "Hoje" : date.split('-').reverse().join('/');
        
        const list = document.getElementById('historyList');
        const dayData = history[date];

        if(!dayData || !dayData.items.length) {
            list.innerHTML = "<li style='opacity:0.7'>Nenhuma movimenta√ß√£o.</li>";
            return;
        }

        list.innerHTML = "";
        // Mostra as √∫ltimas movimenta√ß√µes primeiro
        [...dayData.items].reverse().forEach(item => {
            list.innerHTML += `<li>
                <span>${item.time} - ${item.name}</span>
                <strong>${item.qty} un</strong>
            </li>`;
        });
    }

    function updateKPIs() {
        const date = getSelectedDate();
        const dayData = history[date];
        const negatives = inventory.filter(i => i.qty < 0).length;

        document.getElementById('kpiTotalToday').innerText = dayData ? dayData.total : 0;
        document.getElementById('kpiNegatives').innerText = negatives;
    }

    function updateCharts() {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        const ctxLine = document.getElementById('lineChart').getContext('2d');
        
        // Pega √∫ltimos 7 dias
        const dates = [];
        const totals = [];
        for(let i=6; i>=0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const iso = d.toISOString().split('T')[0];
            dates.push(iso.slice(5).split('-').reverse().join('/')); // DD/MM
            totals.push(history[iso] ? history[iso].total : 0);
        }

        // Calcula varia√ß√£o
        const variations = totals.map((val, i) => {
            if(i === 0) return 0;
            const prev = totals[i-1];
            return prev === 0 ? (val > 0 ? 100 : 0) : ((val - prev)/prev) * 100;
        });

        if(barChart) barChart.destroy();
        if(lineChart) lineChart.destroy();

        const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

        barChart = new Chart(ctxBar, {
            type: 'bar',
            data: { labels: dates, datasets: [{ label: 'Sa√≠das', data: totals, backgroundColor: '#0f766e', borderRadius: 4 }] },
            options: commonOptions
        });

        lineChart = new Chart(ctxLine, {
            type: 'line',
            data: { labels: dates, datasets: [{ label: 'Varia√ß√£o %', data: variations, borderColor: '#f59e0b', tension: 0.3, fill: true, backgroundColor: 'rgba(245, 158, 11, 0.1)' }] },
            options: commonOptions
        });
    }

    // --- SISTEMA ---
    function save() { 
        localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory)); 
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); 
    }
    
    function resetSystem() {
        if(confirm("ATEN√á√ÉO: Isso apagar√° TODO o estoque e hist√≥rico. Continuar?")) {
            localStorage.clear();
            location.reload();
        }
    }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function log(msg) { document.getElementById('log').innerText = msg + "\n" + document.getElementById('log').innerText; }

    window.onload = function() {
        document.getElementById('dateFilter').value = getToday();
        renderAll();
    };

</script>
</body>
</html>
